---
layout: post
title: iptables 控制脚本
categories: Security
description: iptables 控制脚本
keywords: centos, iptables
---

Content here

# iptables 控制脚本
## 默认环境

- CentOS6
- iptables开启，配置文件如下

```shell
# Generated by iptables-save v1.4.7 on Tue Aug 20 10:36:55 2019
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [8003150:2363640163]
-A INPUT -p tcp  -m state --state NEW -m tcp --dport 9081 -j ACCEPT
-A INPUT -p tcp  -m state --state NEW -m tcp --dport 8099 -j ACCEPT
-A INPUT -p tcp  -m state --state NEW -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp  -m state --state NEW -m tcp --dport 4118 -j ACCEPT
-A INPUT -p tcp  -m state --state NEW -m tcp --dport 8088 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp     -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Tue Aug 20 10:36:55 2019

```


## 需求
- 默认情况下放行相关端口入向流量；
- 特殊情况下需要阻断相关端口入向流量；
- 阻断期间需要排除特定地址或者地址段；
- 后期恢复到初始状态；
- [fw_control.sh](http://mingsec.com/shell/fw_control.sh "fw_control.sh")


```shell
#!/bin/bash

function CheakIP()   
{
	if [[ "$1" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\/[0-9]{1,2}$ ]] ;then
		echo "IP地址格式检查通过"
	else
		echo "IP地址格式检查错误，请重新运行脚本。"
		exit 0
	fi
}

read -p "请选择所需功能：1、关闭防火墙入向流量；2、启用防火墙入向流量  " Choose

if [ "$Choose" == 1 ];then
	echo "您输入的选项是 1、关闭防火墙入向流量。"
	read -p "请输入排除ip地址(eg.192.168.1.1/32) ：" Exc_ip
	echo "您输入的地址是：$Exc_ip，正在运行检查函数......"
	CheakIP $Exc_ip
	sed "s|-p\ tcp|-p\ tcp\ -s\ $Exc_ip|g" /etc/sysconfig/iptables -i
	sed "/--dport\ 22/s|-s\ $Exc_ip||g" /etc/sysconfig/iptables -i
	/etc/init.d/iptables restart
	echo "防火墙入向流量已关闭。"
elif [ "$Choose" == 2 ];then
	echo "您输入的选项是 2、启用防火墙入向流量。"
	Soc_IP=`cat /etc/sysconfig/iptables | grep / | awk 'NR==1 {print $6}'`
	echo "配置文件中的排除IP是 $Soc_IP 。" 
	read -p "请输入排除ip地址(eg.192.168.1.1/32) ：" Exc_ip
	echo "您输入的地址是：$Exc_ip，正在运行检查函数......"
	CheakIP $Exc_ip
	sed "s|-s\ $Exc_ip\ ||g" /etc/sysconfig/iptables -i
	/etc/init.d/iptables restart
	echo "防火墙入向流量已启用。"
else
	echo "输入错误，请重新运行脚本。"
fi

```